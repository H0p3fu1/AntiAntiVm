# 参考资料

## 资源

[VM 整理](https://www.bilibili.com/opus/959525234765987858)

## 视频

[【铭凡】全网首发VM17.5.0去虚拟化原理教程](https://www.bilibili.com/video/BV1zh4y1i7CD/)

[vm去虚拟化虚拟机制作全流程，天价虚拟机有多坑？](https://www.bilibili.com/video/BV1vu411b7DC?t=1521)

# 准备工作

- Vmware
- 操作系统镜像
- Phoenix BIOS Editor
- WinHex

# 安装系统

1. 按需进行设置虚拟机参数

2. 在安装系统前，移除可信平台模块，确保将系统固件类型设置为BIOS

3. 安装系统时，使用`Shift + F10`组合键打开命令提示符，执行以下命令

   ```
   reg add "HKEY_LOCAL_MACHINE\SYSTEM\Setup\LabConfig" /f
   reg add "HKEY_LOCAL_MACHINE\SYSTEM\Setup\LabConfig" /v BypassTPMCheck /t reg_dword /d 1 /f
   reg add "HKEY_LOCAL_MACHINE\SYSTEM\Setup\LabConfig" /v BypassSecureBootCheck /t reg_dword /d 1 /f
   reg add "HKEY_LOCAL_MACHINE\SYSTEM\Setup\LabConfig" /v BypassRAMCheck /t reg_dword /d 1 /f
   reg add "HKEY_LOCAL_MACHINE\SYSTEM\Setup\LabConfig" /v BypassStorageCheck /t reg_dword /d 1 /f
   reg add "HKEY_LOCAL_MACHINE\SYSTEM\Setup\LabConfig" /v BypassCPUCheck /t reg_dword /d 1 /f
   ```

4. 成功安装系统

# 修改vmx文件

1. 备份虚拟机安装目录下的`*.vmx`文件

2. 在虚拟机安装目录下的`*.vmx`文件中添加如下代码

   ```
   #过CPUID检测
   cpuid.1.ecx = "0--------------0----------------"
   cpuid.1.edx = "-----------0---------0----------"
   cpuid.1.ecx = "0--------------0----------------"
   cpuid.1.edx = "-----------0---------0----------"
   cpuid.6.eax = "00000000000000000000000000000000"
   cpuid.6.ecx = "00000000000000000000000000000000"
   cpuid.80000002.eax = "0--0-0000---0-0000--00-000--000-"
   cpuid.80000002.ebx = "0--0---00--00-0-0-000---00-00000"
   cpuid.80000002.ecx = "0---0-000--0---00-00-00-00-00000"
   cpuid.80000002.edx = "0-0-00-000-0-0000--0--000--00-0-"
   cpuid.80000003.eax = "0--0----0-0000--00-0000000-0-00-"
   cpuid.80000003.ebx = "0-0-0-0000-0-0000--00-0-0---00-0"
   cpuid.80000003.ecx = "0--0-00-00-0000000-0-00-0-00--0-"
   cpuid.80000003.edx = "00--00-000--000-00-0--0-00---00-"
   cpuid.80000004.eax = "0-00-00000--000000--0-0-00---00-"
   cpuid.80000004.ebx = "0000000000000000000000000-0--000"
   cpuid.80000004.ecx = "00000000000000000000000000000000"
   cpuid.80000004.edx = "00000000000000000000000000000000"
   
   #其他设置
   hypervisor.cpuid.v0 = "FALSE"
   board-id.reflectHost = "FALSE"
   hw.model.reflectHost = "TRUE"
   serialNumber.reflectHost = "TRUE"
   smbios.reflectHost = "TRUE"
   SMBIOS.noOEMStrings = "TRUE"
   #isolation.tools.getPtrLocation.disable = "TRUE"
   #isolation.tools.setPtrLocation.disable = "TRUE"
   #isolation.tools.setVersion.disable = "TRUE"
   #isolation.tools.getVersion.disable = "TRUE"
   monitor_control.disable_directexec = "TRUE"
   monitor_control.disable_chksimd = "TRUE"
   monitor_control.disable_ntreloc = "TRUE"
   monitor_control.disable_selfmod = "TRUE"
   monitor_control.disable_reloc = "TRUE"
   monitor_control.disable_btinout = "TRUE"
   monitor_control.disable_btmemspace = "TRUE"
   monitor_control.disable_btpriv = "TRUE"
   monitor_control.disable_btseg = "TRUE"
   #monitor_control.restrict_backdoor = "TRUE"
   ```

   注1：#表示注释

   注2：恢复#注释的设置将会导致`Vmtools.exe`无法正常运行

3. 保存修改

# 修改BIOS文件

1. 备份VMware Workstation安装目录下的`x64\BIOS.440.ROM`文件

2. 打开Phoenix BIOS Editor软件

3. 打开VMware Workstation安装目录下的`x64\BIOS.440.ROM`文件

4. 选择DMI Strings窗口，将字段修改如下

   | Description                   | String                                                       |
   | ----------------------------- | ------------------------------------------------------------ |
   | Motherboard Manufacturer Name | 'ASUSTeK COMPUTER INC'                                       |
   | Motherboard Model             | 'B75-D3'                                                     |
   | Motherboard Version           | 'To be filled by O.E.M'                                      |
   | Serial Number                 | 'To be filled by O.E.M'                                      |
   | System Manufacturer Name      | 'ASUS, Inc.'                                                 |
   | System Product Name           | 'All Series'                                                 |
   | System Version                | 'To be filled by O.E.M'                                      |
   | System Serial Number          | 'To be filled by O.E.M'                                      |
   | Chassis Manufacturer Name     | 'To be filled by O.E.M'                                      |
   | Chassis Version               | 'To be filled by O.E.M'                                      |
   | Chassis Serial Number         | 'To be filled by O.E.M'                                      |
   | Chassis Model                 | 'To be filled by O.E.M'                                      |
   | UUID                          | 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h, 00h |

5. 保存修改

# 修改vmware-vmx.exe文件

1. 备份VMware Workstation安装目录下的`x64\vmware-vmx.exe`文件
2. 打开WinHex软件
3. 打开VMware Workstation安装目录下的`x64\vmware-vmx.exe`文件
4. 修改原理
   1. 在虚拟机内打开设备管理
   2. 找到对应设备项
   3. 打开属性界面，选择详细信息选项卡
   4. 在下拉列表中选择`硬件Id`项
   5. 可以看到15AD、1975等字样，它们表示品牌和型号
   6. 更多详细信息可使用`x64dbg.exe`对`vmware-vmx.exe`进行调试得到
5. 修改硬盘
   1. IDE格式
      1. 搜索`VMware Virtual IDE Hard Drive`
      2. 改为`Samsung SSD 860 EVO 120GB`
   2. SCSI格式
      1. 搜索`VMware Virtual SCSI Hard Drive`
      2. 改为`Samsung SSD 860 EVO 120GB`
   3. SATA格式
      1. 搜索`VMware Virtual SATA Hard Drive`
      2. 改为`Samsung SSD 860 EVO 120GB`
   4. NVMe格式
      1. 搜索`VMware Virtual NVMe Disk`
      2. 改为`Samsung SSD 860 EVO 120GB`
6. 修改声卡
   1. 搜索FFBAAD15，AD15改为EC10，7719改为8680
   2. 再次搜索FFBAAD15，AD15改为EC10，7719改为8680
   3. 搜索43047519AD15，上下AD15改为8680
7. 修改网卡
   1. 搜索66894717B8AD15，AD15改为8680
8. 修改主板芯片组
   1. 搜索86809071，9071改为DE10
9. 修改显卡
   1. 搜索F3AAB8AD15，AD15改为DE10
   2. 搜索7526B80504，0504改为对应显卡ID，例如3070Ti的显卡代码是：NVIDIA_DEV.2182 = "NVIDIA GeForce GTX 1660 Ti"，因此应按照小端序修改为8221

# 安装显卡驱动

1. 安装对应显卡型号的显卡驱动

# 安装鼠标驱动

1. 安装鼠标驱动

# 修改MAC地址

```
以00:05:69、00:0C:29、00:50:56开头的MAC地址对应VMware提供商
以00:03:FF开头的MAC地址对应VirtualPC提供商
以08:00:27开头的MAC地址对应VirtualBox提供商  
```

1. 关闭虚拟机
2. 编辑虚拟机设置
3. 选择`网络适配器`，点击`高级`，修改MAC地址为除上述地址以外的任意地址，例如`00:11:56`
4. 点击`确定`，保存修改

# 卸载Vmware Tools

1. 卸载Vmware Tools

# 卸载服务

1. 卸载所有虚拟机相关服务

# 删除文件

1. 删除所有磁盘下虚拟机相关文件

# 与反虚拟机系统的对抗

1. 用户层通过Hook技术避免文件、注册表、进程等检测
2. 驱动层通过Hook技术避免文件、注册表、进程等检测
3. 其他对抗方式